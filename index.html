<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Oscilloscope Music Lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {background:#050505;color:#0f0;font-family:monospace;padding:20px;}
canvas {background:black;border:1px solid #222;display:block;margin-bottom:10px;}
button,input,select,textarea {background:#111;color:#0f0;border:1px solid #333;margin:2px 0;}
.osc {border:1px solid #222;padding:8px;margin-bottom:8px;}
.row {display:flex;gap:6px;align-items:center;}
.row input[type=range] {flex:1;}
.row input[type=number] {width:80px;}
textarea {width:100%;height:120px;}
label {display:block;margin-top:10px;}
</style>
</head>
<body>

<canvas id="scope" width="700" height="200"></canvas>

<button id="start">Start</button>
<button id="stop">Stop</button>
<button id="addOsc">Add Oscillator</button>

<label>
Preset JSON (paste here)
<textarea id="jsonInput"></textarea>
<button id="applyJson">Apply JSON</button>
</label>

<label>
Current Patch JSON (read-only)
<textarea id="jsonOutput" readonly></textarea>
</label>

<div id="oscList"></div>

<script>
let ctx=null, analyser, masterGain;
let oscillators=[];
let running=false;
const MASTER_VOLUME=0.4;
const scope=document.getElementById("scope");
const sctx=scope.getContext("2d");
const oscList=document.getElementById("oscList");

function link(range, number, callback){
  range.oninput = () => { number.value = range.value; callback(Number(range.value)); updateJSON(); };
  number.oninput = () => { range.value = number.value; callback(Number(number.value)); updateJSON(); };
}

function initAudio(){
  if(!ctx){
    ctx=new AudioContext();
    analyser=ctx.createAnalyser();
    masterGain=ctx.createGain();
    masterGain.gain.value=0;
    analyser.fftSize=2048;
    masterGain.connect(analyser);
    analyser.connect(ctx.destination);
  }
}

function addOscillator(preset){
  initAudio();
  const data=preset||{wave:"sine",frequency:220,gain:0.3,duration:1,infinite:true,loop:false};
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  osc.type=data.wave;
  osc.frequency.value=data.frequency;
  gain.gain.value=data.gain;
  osc.connect(gain);
  gain.connect(masterGain);

  const obj={osc,gain,preset:data,started:false,timeout:null};
  oscillators.push(obj);

  // Schedule start with duration/loop logic
  function startOsc(){
    if(!obj.started){
      obj.osc.start();
      obj.started=true;
    }
    if(!data.infinite){
      obj.timeout=setTimeout(()=>{
        try{obj.osc.stop();}catch{}
        if(data.loop){
          const newOsc=ctx.createOscillator();
          newOsc.type=data.wave;
          newOsc.frequency.value=data.frequency;
          newOsc.connect(gain);
          obj.osc=newOsc;
          obj.started=false;
          startOsc();
        }
      },data.duration*1000);
    }
  }
  if(running) startOsc();
  obj.startOsc=startOsc;

  // UI
  const div=document.createElement("div");
  div.className="osc";
  div.innerHTML=`
    <div class="row">freq<input type="range" min="20" max="2000" value="${data.frequency}"><input type="number" min="20" max="2000" value="${data.frequency}"></div>
    <div class="row">gain<input type="range" min="0" max="1" step="0.01" value="${data.gain}"><input type="number" min="0" max="1" step="0.01" value="${data.gain}"></div>
    <div class="row">duration<input type="range" min="0.1" max="10" step="0.1" value="${data.duration}"><input type="number" min="0.1" max="10" step="0.1" value="${data.duration}"></div>
    <div class="row">infinite<input type="checkbox" ${data.infinite?"checked":""}> loop<input type="checkbox" ${data.loop?"checked":""}></div>
    <div class="row">wave<select>
      <option ${data.wave==="sine"?"selected":""}>sine</option>
      <option ${data.wave==="square"?"selected":""}>square</option>
      <option ${data.wave==="sawtooth"?"selected":""}>sawtooth</option>
      <option ${data.wave==="triangle"?"selected":""}>triangle</option>
    </select></div>
  `;
  const inputs=div.querySelectorAll("input[type=range],input[type=number]");
  link(inputs[0],inputs[1],v=>{osc.frequency.value=v;});
  link(inputs[2],inputs[3],v=>{gain.gain.value=v;});
  link(inputs[4],inputs[5],v=>{data.duration=Number(inputs[5].value);});
  const checkboxes=div.querySelectorAll("input[type=checkbox]");
  checkboxes[0].onchange=()=>{data.infinite=checkboxes[0].checked;};
  checkboxes[1].onchange=()=>{data.loop=checkboxes[1].checked;};
  const wave=div.querySelector("select");
  wave.onchange=()=>{data.wave=wave.value;};
  oscList.appendChild(div);
  updateJSON();
}

function drawScope(){
  const buf=new Uint8Array(analyser.fftSize);
  function loop(){
    if(!running) return;
    analyser.getByteTimeDomainData(buf);
    sctx.fillStyle="black";
    sctx.fillRect(0,0,scope.width,scope.height);
    sctx.strokeStyle="#0f0";
    sctx.beginPath();
    buf.forEach((v,i)=>{
      const x=i/buf.length*scope.width;
      const y=v/255*scope.height;
      if(i===0) sctx.moveTo(x,y); else sctx.lineTo(x,y);
    });
    sctx.stroke();
    requestAnimationFrame(loop);
  }
  loop();
}

function updateJSON(){
  const patch=oscillators.map(o=>({
    wave:o.preset.wave,
    frequency:+o.preset.frequency.toFixed(2),
    gain:+o.preset.gain.toFixed(2),
    duration:+o.preset.duration.toFixed(2),
    infinite:o.preset.infinite,
    loop:o.preset.loop
  }));
  document.getElementById("jsonOutput").value=JSON.stringify(patch,null,2);
}

document.getElementById("applyJson").onclick=()=>{
  try{
    const data=JSON.parse(document.getElementById("jsonInput").value);
    data.forEach(o=>addOscillator(o));
  }catch{alert("Invalid JSON");}
};

// PAUSE / PLAY using masterGain
document.getElementById("start").onclick=()=>{
  initAudio();
  running=true;
  masterGain.gain.setTargetAtTime(MASTER_VOLUME,ctx.currentTime,0.01);
  oscillators.forEach(o=>{
    if(!o.started) o.startOsc();
  });
  drawScope();
};

document.getElementById("stop").onclick=()=>{
  running=false;
  masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.01);
};

document.getElementById("addOsc").onclick=()=>addOscillator();
</script>
</body>
</html>
