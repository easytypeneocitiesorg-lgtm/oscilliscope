<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Oscilloscope Music Lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  background:#050505;
  color:#0f0;
  font-family:monospace;
  padding:20px;
}
canvas {
  background:black;
  border:1px solid #222;
  display:block;
  margin-bottom:10px;
}
button,input,select,textarea {
  background:#111;
  color:#0f0;
  border:1px solid #333;
}
.osc {
  border:1px solid #222;
  padding:8px;
  margin-bottom:8px;
}
.row {
  display:flex;
  gap:6px;
  align-items:center;
}
.row input[type=range] {
  flex:1;
}
.row input[type=number] {
  width:80px;
}
textarea {
  width:100%;
  height:120px;
}
label {
  display:block;
  margin-top:10px;
}
</style>
</head>
<body>

<canvas id="scope" width="700" height="200"></canvas>

<button id="start">Start</button>
<button id="addOsc">Add Oscillator</button>

<label>
Preset JSON (paste here)
<textarea id="jsonInput"></textarea>
<button id="applyJson">Apply JSON</button>
</label>

<label>
Current Patch JSON (read-only)
<textarea id="jsonOutput" readonly></textarea>
</label>

<div id="oscList"></div>

<script>
let ctx, analyser, masterGain;
let oscillators = [];
let running = false;

const scope = document.getElementById("scope");
const sctx = scope.getContext("2d");
const oscList = document.getElementById("oscList");

function link(range, number, callback){
  range.oninput = () => {
    number.value = range.value;
    callback(range.value);
    updateJSON();
  };
  number.oninput = () => {
    range.value = number.value;
    callback(number.value);
    updateJSON();
  };
}

function initAudio(){
  ctx = new AudioContext();
  analyser = ctx.createAnalyser();
  masterGain = ctx.createGain();
  masterGain.gain.value = 0.4;
  analyser.fftSize = 2048;
  masterGain.connect(analyser);
  analyser.connect(ctx.destination);
}

function addOscillator(data){
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const delay = ctx.createDelay(5);

  const preset = data || {
    wave:"sine",
    frequency:220,
    gain:0.3,
    delay:0
  };

  osc.type = preset.wave;
  osc.frequency.value = preset.frequency;
  gain.gain.value = preset.gain;
  delay.delayTime.value = preset.delay;

  osc.connect(gain);
  gain.connect(delay);
  delay.connect(masterGain);
  osc.start();

  const index = oscillators.length;
  oscillators.push({osc,gain,delay,preset});

  const div = document.createElement("div");
  div.className = "osc";
  div.innerHTML = `
    <div class="row">
      freq
      <input type="range" min="20" max="2000" value="${preset.frequency}">
      <input type="number" min="20" max="2000" value="${preset.frequency}">
    </div>
    <div class="row">
      gain
      <input type="range" min="0" max="1" step="0.01" value="${preset.gain}">
      <input type="number" min="0" max="1" step="0.01" value="${preset.gain}">
    </div>
    <div class="row">
      delay
      <input type="range" min="0" max="1" step="0.01" value="${preset.delay}">
      <input type="number" min="0" max="1" step="0.01" value="${preset.delay}">
    </div>
    <div class="row">
      wave
      <select>
        <option ${preset.wave==="sine"?"selected":""}>sine</option>
        <option ${preset.wave==="square"?"selected":""}>square</option>
        <option ${preset.wave==="sawtooth"?"selected":""}>sawtooth</option>
        <option ${preset.wave==="triangle"?"selected":""}>triangle</option>
      </select>
    </div>
  `;

  const inputs = div.querySelectorAll("input");
  const wave = div.querySelector("select");

  link(inputs[0], inputs[1], v => osc.frequency.value = v);
  link(inputs[2], inputs[3], v => gain.gain.value = v);
  link(inputs[4], inputs[5], v => delay.delayTime.value = v);

  wave.onchange = () => {
    osc.type = wave.value;
    updateJSON();
  };

  oscList.appendChild(div);
  updateJSON();
}

function drawScope(){
  const buf = new Uint8Array(analyser.fftSize);
  function loop(){
    analyser.getByteTimeDomainData(buf);
    sctx.fillStyle="black";
    sctx.fillRect(0,0,scope.width,scope.height);
    sctx.strokeStyle="#0f0";
    sctx.beginPath();
    buf.forEach((v,i)=>{
      const x=i/buf.length*scope.width;
      const y=v/255*scope.height;
      if(i===0)sctx.moveTo(x,y);
      else sctx.lineTo(x,y);
    });
    sctx.stroke();
    requestAnimationFrame(loop);
  }
  loop();
}

function updateJSON(){
  const patch = oscillators.map(o=>({
    wave:o.osc.type,
    frequency:+o.osc.frequency.value.toFixed(2),
    gain:+o.gain.gain.value.toFixed(2),
    delay:+o.delay.delayTime.value.toFixed(2)
  }));
  document.getElementById("jsonOutput").value =
    JSON.stringify(patch,null,2);
}

document.getElementById("applyJson").onclick = ()=>{
  try{
    const data = JSON.parse(document.getElementById("jsonInput").value);
    oscList.innerHTML="";
    oscillators=[];
    data.forEach(o=>addOscillator(o));
  }catch{
    alert("Invalid JSON");
  }
};

start.onclick=()=>{
  if(!running){
    initAudio();
    addOscillator();
    drawScope();
    running=true;
    start.textContent="Stop";
  }else{
    ctx.close();
    location.reload();
  }
};

addOsc.onclick=()=>ctx&&addOscillator();
</script>

</body>
</html>
